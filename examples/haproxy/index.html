<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.17" />
    <meta name="description" content="remco is a lightweight configuration management tool">
<meta name="author" content="The remco authors">

    <link rel="shortcut icon" href="../../images/favicon.png" type="image/x-icon" />

    
    <title>Dynamic haproxy configuration with docker, registrator and etcd</title>
    <link href="../../css/nucleus.css" rel="stylesheet">
    <link href="../../css/font-awesome.min.css" rel="stylesheet">
    <link href="../../css/hybrid.css" rel="stylesheet">
    <link href="../../css/featherlight.min.css" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="../../css/horsey.css" rel="stylesheet">
    <link href="../../css/theme.css" rel="stylesheet">
    <link href="../../css/hugo-theme.css" rel="stylesheet">
    <script src="../../js/jquery-2.x.min.js"></script>
    <style type="text/css">:root #header + #content > #left > #rlblock_left
    {display:none !important;}</style>
    
<link href="../../style.css" rel="stylesheet">
  </head>
  <body class="" data-url="/examples/haproxy/">
    <nav id="sidebar">
  <div id="header-wrapper">
    <div id="header">
      REMCO
    </div>
    
</div>


  <div class="highlightable">
    <ul class="topics">
      
      
        
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/details/">
        <a href="../../details/">
          <span>
            
              <b>1. </b>
            
             Details
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/details/template-resource/">
              <a href="../../details/template-resource/">
                <span>template resource     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/details/exec-mode/">
              <a href="../../details/exec-mode/">
                <span>exec mode     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/details/commands/">
              <a href="../../details/commands/">
                <span>commands     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/details/zombie-reaping/">
              <a href="../../details/zombie-reaping/">
                <span>zombie reaping     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/details/backends/">
              <a href="../../details/backends/">
                <span>backends     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/details/plugins/">
              <a href="../../details/plugins/">
                <span>plugins     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/details/process-lifecycle/">
              <a href="../../details/process-lifecycle/">
                <span>process lifecycle     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/details/telemetry/">
              <a href="../../details/telemetry/">
                <span>Telemetry     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/config/">
        <a href="../../config/">
          <span>
            
              <b>2. </b>
            
             Configuration
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/config/environment-variables/">
              <a href="../../config/environment-variables/">
                <span>environment variables     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/config/configuration-options/">
              <a href="../../config/configuration-options/">
                <span>configuration options     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/config/sample-config/">
              <a href="../../config/sample-config/">
                <span>sample config file     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/config/sample-resource/">
              <a href="../../config/sample-resource/">
                <span>sample resource     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/template/">
        <a href="../../template/">
          <span>
            
              <b>3. </b>
            
             Template
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/template/template-functions/">
              <a href="../../template/template-functions/">
                <span>template functions     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/template/template-filters/">
              <a href="../../template/template-filters/">
                <span>template filters     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/plugins/">
        <a href="../../plugins/">
          <span>
            
              <b>4. </b>
            
             Plugins
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/plugins/env-plugin-example/">
              <a href="../../plugins/env-plugin-example/">
                <span>env plugin example     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/plugins/consul-plugin-example/">
              <a href="../../plugins/consul-plugin-example/">
                <span>consul plugin example     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  parent" data-nav-id="/examples/">
        <a href="../../examples/">
          <span>
            
              <b>5. </b>
            
             Examples
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item active" data-nav-id="/examples/haproxy/">
              <a href="../../examples/haproxy/">
                <span>Dynamic haproxy configuration with docker, registrator and etcd     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
    </ul>
    <hr>
     
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>
    </section>
  </div>
</nav>

        <section id="body">
        <div id="overlay"></div>

        <div class="padding highlightable">

            <div id="top-bar">
              
              <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                  <span id="sidebar-toggle-span">
                      <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                        <i class="fa fa-bars"></i>
                      </a>
                  </span>
                
                <span id="toc-menu"><a href=""><i class="fa fa-list-alt"></i></a></span>
                
                
                
                
                  
                
                  
                
                  
                    
                    
                <a href="../../examples/" itemprop="url"><span itemprop="title">Examples</span></a> <i class="fa fa-angle-right"></i>
                    
                  
                
                  
                
                  
                
                <span itemprop="title"> Dynamic haproxy configuration with docker, registrator and etcd</span>
              </div>
              
                  <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#the-haproxy-template">The haproxy template</a></li>
<li><a href="#the-remco-configuration-file">The remco configuration file</a></li>
<li><a href="#the-dockerfile">The Dockerfile</a></li>
<li><a href="#build-and-run-the-container">Build and Run the container</a>
<ul>
<li><a href="#build-the-docker-container">Build the docker container:</a></li>
<li><a href="#optionally-test-the-container">Optionally test the container:</a>
<ul>
<li><a href="#put-some-data-into-etcd">put some data into etcd:</a></li>
</ul></li>
<li><a href="#run-registrator">Run registrator</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

              

            </div>
            
    	        <div id="body-inner">
                
                <h1>Dynamic haproxy configuration with docker, registrator and etcd</h1>
                



<h2 id="the-haproxy-template">The haproxy template</h2>

<p>We expect <a href="http://gliderlabs.github.io/registrator/latest/">registrator</a> to write the service data in this format to etcd:</p>

<pre><code>/services/&lt;service-name&gt;/&lt;service-id&gt; = &lt;ip&gt;:&lt;port&gt;
</code></pre>

<p>The scheme (tcp, http) and the host_port of the service is configurable over the following keys:</p>

<pre><code>/config/&lt;service-name&gt;/scheme
/config/&lt;service-name&gt;/host_port
</code></pre>

<p>We create the template for the haproxy configuration file first.
Create the file <strong>haproxy.tmpl</strong> and add the following config blocks:</p>

<p>Some default configuration parameters:</p>

<pre><code>global
    daemon
    maxconn 2048

defaults
    timeout connect 5000ms
    timeout client 500000ms
    timeout server 500000ms
    log global

frontend name_resolver_http
    bind *:80
    mode http
</code></pre>

<hr>

<p>This block creates the <em>http</em> acl&rsquo;s.
We itarate over all directories under /config  (the services) and create a <strong>url_beg</strong> and a <strong>hdr_beg(host)</strong> acl if the service has a scheme configured.
Note that we sort the services by length and iterate in reversed order (longest services first). That way we can have services with the same prefix, for example redis_test, and redis.</p>

<pre><code>{% for dir in lsdir(&quot;/config&quot;) | sortByLength reversed %}
  {% if exists(printf(&quot;/config/%s/scheme&quot;, dir)) %}
    {% if getv(printf(&quot;/config/%s/scheme&quot;, dir)) == &quot;http&quot; %}
      {% if ls(printf(&quot;/services/%s&quot;, dir)) %}
        acl is_{{ dir }} url_beg /{{ dir }}
        acl is_{{ dir }} hdr_beg(host) {{ dir }}
        use_backend {{ dir }}_servers if is_{{ dir }}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}
</code></pre>

<p>If we had one service named redis we would get:</p>

<pre><code>acl is_redis url_beg /redis 
acl is_redis hdr_beg(host) redis
use_backend redis_servers if is_redis
</code></pre>

<hr>

<p>Optional template block to expose a service on an host port:
We iterate over all services under /config, test if the scheme and host_port is configured and create the host port configuration.</p>

<pre><code>{% for dir in lsdir(&quot;/config&quot;) %}
  {% if exists (printf (&quot;/config/%s/scheme&quot;, dir )) %}
    {% if exists (printf(&quot;/config/%s/host_port&quot;, dir )) %}
      {% if ls(printf(&quot;/services/%s&quot;, dir)) %}
                frontend {{ dir }}_port
                mode {{ getv (printf(&quot;/config/%s/scheme&quot;, dir)) }}
                bind *:{{ getv (printf (&quot;/config/%s/host_port&quot;, dir)) }}
                default_backend {{ dir }}_servers
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}
</code></pre>

<p>If we had one service named redis with scheme=tcp and host_port=6379 we would get:</p>

<pre><code>frontend redis_port
mode tcp
bind *:6379 
default_backend redis_servers
</code></pre>

<hr>

<p>The last block creates the haproxy backends.
We iterate over all services and, if a scheme is set, create the backend <em>{service_name}_servers</em>.</p>

<pre><code>{% for dir in lsdir(&quot;/services&quot;) %}
  {% if exists(printf(&quot;/config/%s/scheme&quot;, dir)) %}
backend {{ dir }}_servers
        mode {{ getv (printf (&quot;/config/%s/scheme&quot;, dir)) }}
        {% for i in gets (printf(&quot;/services/%s/*&quot;, dir)) %}
            server server_{{ dir }}_{{ base (i.Key) }} {{ i.Value }}
        {% endfor %}
    {% endif %}
{% endfor %}
</code></pre>

<p>If we had one service named redis with scheme=tcp we could get for example:</p>

<pre><code>backend redis_servers   
  mode tcp
    server server_redis_1 192.168.0.10:32012
    server server_redis_2 192.168.0.10:35013
</code></pre>

<hr>

<h2 id="the-remco-configuration-file">The remco configuration file</h2>

<p>We also need to create the remco configuration file.
Create a file named <strong>config</strong> and insert the following toml configuration.</p>

<pre><code class="language-toml">################################################################
# Global configuration
################################################################
log_level = &quot;debug&quot;
log_format = &quot;text&quot;

[[resource]]
name = &quot;haproxy&quot;

[[resource.template]]
  src = &quot;/etc/remco/templates/haproxy.tmpl&quot;
  dst = &quot;/etc/haproxy/haproxy.cfg&quot;
  reload_cmd 	  = &quot;haproxy -f {{.dst}} -p /var/run/haproxy.pid -D -sf `cat /var/run/haproxy.pid`&quot;

  [resource.backend]
    [resource.backend.etcd]
      nodes = [&quot;${ETCD_NODE}&quot;]
      keys = [&quot;/services&quot;, &quot;/config&quot;]
      watchKeys = [&quot;/haproxy/reload&quot;]
      watch = true
      interval = 60
</code></pre>

<h2 id="the-dockerfile">The Dockerfile</h2>

<pre><code>FROM alpine:3.4

ENV REMCO_VER 0.8.0

RUN apk --update add --no-cache haproxy bash ca-certificates
RUN wget https://github.com/HeavyHorst/remco/releases/download/v${REMCO_VER}/remco_${REMCO_VER}_linux_amd64.zip &amp;&amp; \
    unzip remco_${REMCO_VER}_linux_amd64.zip &amp;&amp; rm remco_${REMCO_VER}_linux_amd64.zip &amp;&amp; \
    mv remco_linux /bin/remco

COPY config /etc/remco/config
COPY haproxy.tmpl /etc/remco/templates/haproxy.tmpl

ENTRYPOINT [&quot;remco&quot;]
</code></pre>

<h2 id="build-and-run-the-container">Build and Run the container</h2>

<p>You should have three files at this point:</p>

<pre><code>.
├── config
├── Dockerfile
└── haproxy.tmpl
</code></pre>

<h3 id="build-the-docker-container">Build the docker container:</h3>

<pre><code class="language-bash">sudo docker build -t remcohaproxy .
</code></pre>

<h3 id="optionally-test-the-container">Optionally test the container:</h3>

<h4 id="put-some-data-into-etcd">put some data into etcd:</h4>

<pre><code class="language-bash">etcdctl set /services/exampleService/1 someip:port
etcdctl set /config/exampleService/scheme http
etcdctl set /config/exampleService/host_port 1234
</code></pre>

<p>In this example we connect to a local etcd cluster.</p>

<pre><code class="language-bash">sudo docker run --rm -ti --net=host -e ETCD_NODE=http://localhost:2379 remcohaproxy
</code></pre>

<p>You should see something like this:</p>

<pre><code>[Dec 16 18:26:20]  INFO remco[1]: Target config out of sync config=/etc/haproxy/haproxy.cfg resource=haproxy source=resource.go:66
[Dec 16 18:26:20] DEBUG remco[1]: Overwriting target config config=/etc/haproxy/haproxy.cfg resource=haproxy source=resource.go:66
[Dec 16 18:26:20] DEBUG remco[1]: Running haproxy -f /etc/haproxy/haproxy.cfg -p /var/run/haproxy.pid -D -sf `cat /var/run/haproxy.pid` resource=haproxy source=resource.go:66
[Dec 16 18:26:20] DEBUG remco[1]: &quot;&quot; resource=haproxy source=resource.go:66
[Dec 16 18:26:20]  INFO remco[1]: Target config has been updated config=/etc/haproxy/haproxy.cfg resource=haproxy source=resource.go:66
[Dec 16 18:26:20] DEBUG remco[1]: [Reaped child process 60] source=main.go:87
[Dec 16 18:26:24] DEBUG remco[1]: Retrieving keys backend=etcd key_prefix= resource=haproxy source=resource.go:66
[Dec 16 18:26:24] DEBUG remco[1]: Compiling source template resource=haproxy source=resource.go:66 template=/etc/remco/templates/haproxy.tmpl
[Dec 16 18:26:24] DEBUG remco[1]: Comparing staged and dest config files dest=/etc/haproxy/haproxy.cfg resource=haproxy source=resource.go:66 staged=.haproxy.cfg389124299
[Dec 16 18:26:24] DEBUG remco[1]: Target config in sync config=/etc/haproxy/haproxy.cfg resource=haproxy source=resource.go:66
</code></pre>

<h3 id="run-registrator">Run registrator</h3>

<pre><code>sudo docker run -d \
    --name=registrator \
    --net=host \
    --volume=/var/run/docker.sock:/tmp/docker.sock \
    gliderlabs/registrator:latest \
      etcd://localhost:2379/services
</code></pre>

<p>Now every container get automatically registered under /services.
You can then configure the scheme and optionally the host_port of each service that you want to expose.</p>


      
      </div>
    </div>

    <div id="navigation">
        <a class="nav nav-prev" href="../../examples/"> <i class="fa fa-chevron-left"></i></a>
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js"></script>
    <script src="../../js/perfect-scrollbar.min.js"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js"></script>
    <script src="../../js/jquery.sticky-kit.min.js"></script>
    <script src="../../js/featherlight.min.js"></script>
    <script src="../../js/html5shiv-printshiv.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom.71422.js"></script>
    <script src="../../js/learn.js"></script>
    <script src="../../js/hugo-learn.js"></script>
    

  </body>
</html>

